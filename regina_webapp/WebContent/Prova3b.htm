<!DOCTYPE HTML>
<html>
  <head>
    <style>
      body {
        margin: 0px;
        padding: 0px;
      }
      canvas {
        border: 1px solid #9C9898;
      }
      #container {
        background-image: url('./images/EDIFICIO_A_PIANO_PRIMO.jpg');
        width: 1164px;
        height: 500px;
      }
    </style>
    <script src="./libraries/kinetic-v3.9.5.js"></script>
    <script src="./libraries/jquery-1.7.2.min.js"></script>
    <script>

     var stage;
     var layer;
    
     function updateDottedLines(layer) {
    	 console.log("updateDottedLines called ...");
        
    	//var c = layer.polyPnts;
//     	var i=0;
//     	for (i=0;i<=0;i++) {
    		
   	    var c = layer.poly;
	    var polyLine = layer.get('#polyID')[0];
	    
	        polyLine.setPoints([
	          c.start.attrs.x, c.start.attrs.y, 
	          c.control1.attrs.x, c.control1.attrs.y, 
	          c.control2.attrs.x, c.control2.attrs.y,
	          c.control3.attrs.x, c.control3.attrs.y,
	          c.control4.attrs.x, c.control4.attrs.y,
	          c.end.attrs.x, c.end.attrs.y
	        ]);
//    	}   
      }
     
      function buildAnchor(layer, x, y) {
        var anchor = new Kinetic.Circle({
          x: x,
          y: y,
          radius: 3,
          stroke: "#666",
          fill: "#ddd",
          strokeWidth: 2,
          draggable: true
        });

//         // add hover styling
//         anchor.on("mouseover", function() {
//           document.body.style.cursor = "pointer";
//           this.setStrokeWidth(4);
//           //layer.draw();
//         });
//         anchor.on("mouseout", function() {
//           document.body.style.cursor = "default";
//           this.setStrokeWidth(2);
//           //layer.draw();
//         });

        layer.add(anchor);
        return anchor;
      }
      
      function buildPolyObj(layer, polyId, coordArray) {
   	  
    	  var objArr = new Array();
    	  //var objPrv = eval("layer.myNewObj = {}");
    	  //objArr.push(objPrv);
    	  
    	  var c = coordArray.split(",");
    	  var objPriv;
    	  var str;
    	  for (i=0;i<=5;i++) {
			objPriv = {
    	      start: buildAnchor(layer, c[0],c[1]),
	          control1: buildAnchor(layer, c[2],c[3]),
	          control2: buildAnchor(layer, c[4],c[5]),
	          control3: buildAnchor(layer, c[6],c[7]),
	          control4: buildAnchor(layer, c[8],c[9]),
	          end: buildAnchor(layer, c[10],c[11])
			};
			//objArr.push(objPriv);
			eval("layer.obj"+i+" = objPriv");
    	  }
    	  c=null;
      }
      
      function createObjects(arr) {
    	  
    	  var poly;
    	  var i=0;
    	  var objPriv;
    	  
    	  for (o in arr) {
    		  
    		var c = arr[o].split(",");  
    		var id = "polyID";
   	        
    		// crate polygon and add it to layer
    		poly = new Kinetic.Polygon({
   		        points: c,
   		        fill: "#00D2F0",
   		        alpha: 0.2,
   		        stroke: "#00D2F0",
   		        strokeWidth: 0,
   		        id: id
   	        });
   	        layer.add(poly);
   	        
   	       layer.beforeDraw(function() {
   	          updateDottedLines(layer);
   	        });
      	    
   	        // create anchor objs and add the to layer.
   	        layer.poly = {
       	      start: buildAnchor(layer, c[0],c[1]),
   	          control1: buildAnchor(layer, c[2],c[3]),
   	          control2: buildAnchor(layer, c[4],c[5]),
   	          control3: buildAnchor(layer, c[6],c[7]),
   	          control4: buildAnchor(layer, c[8],c[9]),
   	          end: buildAnchor(layer, c[10],c[11]),
   	          id: id
   			};
   			//objArr.push(objPriv);
   			//layer.polyPnts0 = objPriv;
   			//eval("layer.polyPnts"+i+" = objPriv");
   			//i++;
   			//layer.polyPnts = objPriv;
    	  }
      }

      window.onload = function() {
        stage = new Kinetic.Stage({
          container: "container",
          width: 1164,
          height: 500
        });

        layer = new Kinetic.Layer({
          //drawFunc: drawCurves
        });

        var cPoly1 = "73,192,73,160,340,23,500,109,499,139,342,93";
        var cPoly2 = "626,401,628,324,744,324,994,323,996,403,628,402";
        
        var polyArray = new Array();
        polyArray.push(cPoly1);
        //polyArray.push(cPoly2);
        
        createObjects(polyArray);
        
//         var poly = new Kinetic.Polygon({
// 	        //points: [73, 192, 73, 160, 340, 23, 500, 109, 499, 139, 342, 93],
// 	        points: [626,401,628,324,744,324,994,323,996,403,628,402],
// 	        fill: "#00D2F0",
// 	        alpha: 0.2,
// 	        stroke: "#00D2F0",
// 	        strokeWidth: 0,
// 	        id: "polyLine"
//         });
        
//        add dotted line connectors
        layer.add(poly);
       
        /*
         * update the dotted line points before
         * drawing the layer
         */
        layer.beforeDraw(function() {
          updateDottedLines(layer);
        });
        /*
         * add custom property curve objects to layer so that
         * they can be modified by reference
         */
        layer.poly = {
	          start: buildAnchor(layer, 626,401),
	          control1: buildAnchor(layer, 628,324),
	          control2: buildAnchor(layer, 744,324),
	          control3: buildAnchor(layer, 994,323),
	          control4: buildAnchor(layer, 996,403),
	          end: buildAnchor(layer, 628,402)
        };

        //var coords = "138,27,31,43,11,45,14,81,50,120,180,55";
        //buildPolyObj(layer, 'obj1', coords);
        
//         layer.polyPnts = {
//   	          start: buildAnchor(layer, 626,401),
//   	          control1: buildAnchor(layer, 628,324),
//   	          control2: buildAnchor(layer, 744,324),
//   	          control3: buildAnchor(layer, 994,323),
//   	          control4: buildAnchor(layer, 996,403),
//   	          end: buildAnchor(layer, 628,402),
//   	          name: "plyPnt"
//           };
        
        stage.on("mouseout", function() {
          layer.draw();
        });

        stage.add(layer);
      };
      
    </script>
  </head>
  <body>
    <div id="container"></div>
    <div id="txt">
    	<input value="pressMe" type="button" onclick="gatherPoints()"/>
    	<textarea rows="10" cols="50" id="area"></textarea>
   	</div>
  </body>
</html>